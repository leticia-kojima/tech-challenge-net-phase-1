version: 0.2

env:
  variables:
    DOTNET_ROOT: "/root/dotnet"
  paths:
    - "/root/dotnet"
    - "/root/.dotnet/tools"

phases:
  install:
    commands:
      - echo "Installing .NET 9 Preview manually..."
      - curl -sSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
      - chmod +x dotnet-install.sh
      - ./dotnet-install.sh --version 9.0.302 --install-dir $DOTNET_ROOT
      - dotnet --version
      - echo "Installing ReportGenerator..."
      - dotnet tool install -g dotnet-reportgenerator-globaltool
  pre_build:
    commands:
      - echo Restoring dependencies...
      - dotnet restore
  build:
    commands:
      - echo Building solution...
      - dotnet build --no-restore --configuration Release
      - echo Running tests...
      - dotnet test \
          --configuration Release \
          --no-restore \
          --logger trx \
          --results-directory TestResults \
          /p:CollectCoverage=true \
          /p:CoverletOutputFormat=opencover \
          --collect:"XPlat Code Coverage"
      - echo Generating coverage report...
      - reportgenerator \
          "-reports:**/coverage.*.xml" \
          "-targetdir:Report" \
          -reporttypes:Html
artifacts:
  files:
    - '**/*.trx'
    - 'Report/**/*'

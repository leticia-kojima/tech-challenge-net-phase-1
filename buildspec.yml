version: 0.2

phases:
  install:
    commands:
      - echo "Installing .NET 9 Preview manually..."
      - curl -sSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
      - chmod +x dotnet-install.sh
      - ./dotnet-install.sh --version 9.0.100-preview.3 --install-dir /root/dotnet
      - export PATH="/root/dotnet:$PATH"
      - dotnet --version
      - echo "Installing ReportGenerator..."
      - dotnet tool install -g dotnet-reportgenerator-globaltool
      - export PATH="$PATH:/root/.dotnet/tools"
  pre_build:
    commands:
      - echo Restoring dependencies...
      - dotnet restore
  build:
    commands:
      - echo Building solution...
      - dotnet build --no-restore --configuration Release
      - echo Running tests...
      - dotnet test \
          --configuration Release \
          --no-restore \
          --logger trx \
          --results-directory TestResults \
          /p:CollectCoverage=true \
          /p:CoverletOutputFormat=opencover \
          --collect:"XPlat Code Coverage"
      - echo Generating coverage report...
      - reportgenerator \
          "-reports:**/coverage.*.xml" \
          "-targetdir:Report" \
          -reporttypes:Html
artifacts:
  files:
    - '**/*.trx'
    - 'Report/**/*'